<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sudoku</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            background: #0a0a0a;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
        }

        .game-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            gap: 30px;
            padding-top: 80px;
        }

        .header {
            display: none;
        }

        .title {
            display: none;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 80px);
        }

        .sidebar > div:first-child {
            flex: 0;
        }

        .number-pad {
            margin-top: auto;
            margin-bottom: 0;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 500;
            pointer-events: none;
        }

        .navbar-left, .navbar-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .navbar-btn {
            width: auto;
            height: auto;
            border: none;
            background: none;
            color: #888;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-style: italic;
            transition: all 0.2s ease;
            text-decoration: none;
            pointer-events: all;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        .navbar-btn:hover {
            color: #fff;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.9);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .control-row.actions {
            gap: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 140px;
            text-align: center;
        }

        #newGameBtn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        #newGameBtn.easy {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        #newGameBtn.medium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        #newGameBtn.hard {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .difficulty-icon-btn {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 8px;
            font-size: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .difficulty-icon-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #666;
        }

        .difficulty-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 140px;
            display: none;
            flex-direction: column;
            z-index: 100;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }

        .difficulty-dropdown.show {
            display: flex;
        }

        .difficulty-dropdown-item {
            padding: 10px 16px;
            font-size: 13px;
            background: none;
            border: none;
            color: #ddd;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
            width: 100%;
        }

        .difficulty-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .difficulty-dropdown-item.easy { color: #10b981; }
        .difficulty-dropdown-item.medium { color: #f59e0b; }
        .difficulty-dropdown-item.hard { color: #ef4444; }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            color: #ddd;
            flex: 1;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.1);
        }

        #hintBtn, #clearBtn {
            width: 100%;
        }

        .difficulty-buttons {
            display: none;
        }

        .difficulty-buttons.show {
            display: none;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .difficulty-btn {
            padding: 10px 16px;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            color: #ddd;
        }

        .difficulty-btn.easy { border-color: #10b981; background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .difficulty-btn.easy:hover { background: rgba(16, 185, 129, 0.2); }

        .difficulty-btn.medium { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .difficulty-btn.medium:hover { background: rgba(245, 158, 11, 0.2); }

        .difficulty-btn.hard { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .difficulty-btn.hard:hover { background: rgba(239, 68, 68, 0.2); }

        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 4px;
            padding: 4px;
            background: #333;
            border-radius: 8px;
            border: 4px solid #333;
            width: min(80vw, 80vh);
            height: min(80vw, 80vh);
            aspect-ratio: 1;
        }

        .box {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 0;
            border: 1px solid #666;
        }

        .cell {
            background: #fff;
            border: 1px solid #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
            position: relative;
        }

        .cell:hover {
            background: #f5f5f5;
        }

        .cell.fixed {
            background: #fff;
            color: #1a1a1a;
            cursor: default;
            font-weight: 700;
        }

        .cell.fixed:hover {
            background: #f5f5f5;
        }

        .cell.selected:not(.quarters-mode) {
            background: #2563eb;
            box-shadow: inset 0 0 10px rgba(37, 99, 235, 0.3);
            color: #fff;
        }

        .cell.selected.quarters-mode {
            background: #fff;
            color: #888;
        }

        .cell:not(.fixed).selected:not(.quarters-mode) {
            color: #fff;
        }

        .cell:not(.fixed).selected:not(.quarters-mode).error {
            color: #dc2626;
        }

        .cell.related {
            background: #e3f2fd;
        }

        .cell.related.fixed {
            color: #333;
        }

        .cell.related:not(.fixed) {
            color: #999;
        }

        .cell.same-block {
            background: #f0f7ff;
        }

        .cell.same-block.fixed {
            color: #333;
        }

        .cell.same-block:not(.fixed) {
            color: #999;
        }

        .cell.error {
            color: #dc2626;
            font-weight: 700;
        }

        .cell.related.error {
            color: #dc2626;
        }

        .cell.same-block.error {
            color: #dc2626;
        }

        .cell.selected.error {
            color: #dc2626;
        }

        .cell:not(.fixed).selected:not(.quarters-mode).error {
            color: #dc2626;
        }

        .cell.error:not(.fixed) {
            text-decoration: underline;
            text-decoration-color: #dc2626;
            text-decoration-thickness: 2px;
            text-underline-offset: 2px;
        }

        .cell.hint {
            color: #FFD700;
        }

        .quarters {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 0;
            font-size: 10px;
            pointer-events: none;
        }

        .quarter {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            padding: 1px;
            font-size: 9px;
        }

        .cell.selected:not(.quarters-mode) .quarter {
            color: #fff;
        }

        .cell.selected.quarters-mode .quarter.active {
            background: #2563eb;
            color: #fff;
            border-radius: 2px;
        }

        .cell.selected:not(.quarters-mode) .quarter.active::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            border: 1.5px solid #2563eb;
            border-radius: 1px;
            pointer-events: none;
        }

        .quarters-toggle {
            width: 100%;
            height: 100%;
            font-size: 18px;
            position: relative;
            aspect-ratio: 1;
            grid-column: 3 / 4;
        }

        .quarters-toggle:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
            width: 180px;
        }

        .number-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            color: #ddd;
            padding: 0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-btn:nth-child(10) {
            grid-column: 1 / 3;
            aspect-ratio: auto;
            padding: 10px;
        }

        .number-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #666;
        }

        .number-btn:active {
            transform: scale(0.95);
        }

        .board-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .stats {
            display: flex;
            flex-direction: row;
            gap: 20px;
            font-size: 14px;
            color: #aaa;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            color: #fff;
            font-weight: 600;
        }

        .difficulty-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-right: 20px;
            border-right: 1px solid #555;
        }

        .difficulty-display .stat-label {
            color: #666;
        }

        .difficulty-display .stat-value {
            font-weight: 700;
        }

        .difficulty-display .stat-value.easy {
            color: #10b981;
        }

        .difficulty-display .stat-value.medium {
            color: #f59e0b;
        }

        .difficulty-display .stat-value.hard {
            color: #ef4444;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .info-modal {
            z-index: 1001;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #1a1a1a;
            border: 2px solid #2563eb;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 20px;
        }

        .modal-text {
            font-size: 14px;
            color: #aaa;
            line-height: 1.8;
            overflow-y: auto;
            flex: 1;
            margin-bottom: 30px;
            padding-right: 15px;
        }

        .modal-text h3 {
            font-size: 18px;
            color: #2563eb;
            margin-top: 25px;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .modal-text h3:first-child {
            margin-top: 0;
        }

        .modal-text p {
            margin: 0 0 16px 0;
            color: #bbb;
        }

        .modal-text ul {
            margin: 0 0 16px 20px;
            padding: 0;
            list-style-position: inside;
        }

        .modal-text li {
            margin-bottom: 10px;
            color: #bbb;
        }

        .modal-text li strong {
            color: #fff;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            flex-shrink: 0;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #fff;
        }

        .modal-btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
        }

        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ddd;
            border: 1px solid #444;
        }

        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-left">
            <button class="navbar-btn" id="infoBtn" title="Game Info">‚ìò</button>
        </div>
        <div class="navbar-right">
            <a href="../index.html" class="navbar-btn" title="Exit">‚úï</a>
        </div>
    </div>

    <!-- Game Info Modal -->
    <div class="modal info-modal" id="infoModal">
        <div class="modal-content">
            <div class="modal-title">How to Play Sudoku</div>
            <div class="modal-text">
                <h3>Objective</h3>
                <p>Fill the 9x9 grid so that each row, column, and 3x3 box contains the numbers 1-9 exactly once. No repetition allowed!</p>

                <h3>The Rules</h3>
                <ul>
                    <li>Each row must contain digits 1-9 with no repeats</li>
                    <li>Each column must contain digits 1-9 with no repeats</li>
                    <li>Each of the nine 3x3 boxes must contain digits 1-9 with no repeats</li>
                    <li>Some cells are pre-filled - you cannot change these</li>
                </ul>

                <h3>How to Play</h3>
                <ul>
                    <li><strong>Click a cell:</strong> Select any empty cell to fill</li>
                    <li><strong>Enter a number:</strong> Use the number pad (1-9) to enter your guess</li>
                    <li><strong>Delete a number:</strong> Press the delete button to clear a cell you filled</li>
                    <li><strong>Check for errors:</strong> The game will highlight wrong entries in red</li>
                </ul>

                <h3>Using Hints</h3>
                <ul>
                    <li>You get 3 hints per game</li>
                    <li>Press the HINT button to reveal one correct number</li>
                    <li>Use hints strategically when you're stuck</li>
                </ul>

                <h3>Difficulty Levels</h3>
                <ul>
                    <li><strong>Easy:</strong> 45 clues - perfect for beginners, fewer cells to fill</li>
                    <li><strong>Medium:</strong> 36 clues - a good challenge, more cells to figure out</li>
                    <li><strong>Hard:</strong> 27 clues - for experienced players, lots of deduction needed</li>
                </ul>

                <h3>Strategy Tips</h3>
                <ul>
                    <li>Look for cells where only one number is possible</li>
                    <li>Check rows, columns, and 3x3 boxes to eliminate possibilities</li>
                    <li>Start with areas that have many given numbers</li>
                    <li>Don't guess randomly - use logic to deduce the answer</li>
                    <li>If you make a mistake, use the delete button and try again</li>
                </ul>

                <h3>How to Start</h3>
                <p>Click "New Game" to start, choose a difficulty level, and begin solving!</p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" id="closeInfoBtn">Got it!</button>
            </div>
        </div>
    </div>

    <div class="game-container">
        <div class="header">
            <div class="title">Sudoku</div>
        </div>

        <div class="sidebar">
            <div class="controls">
                <div class="control-row">
                    <button class="btn" id="newGameBtn">New Game</button>
                    <div class="difficulty-icon-btn" id="difficultyBtn">‚öôÔ∏è
                        <div class="difficulty-dropdown" id="difficultyDropdown">
                            <button class="difficulty-dropdown-item easy" data-difficulty="easy">Easy</button>
                            <button class="difficulty-dropdown-item medium" data-difficulty="medium">Medium</button>
                            <button class="difficulty-dropdown-item hard" data-difficulty="hard">Hard</button>
                        </div>
                    </div>
                </div>
                <div class="control-row actions">
                    <button class="btn btn-secondary" id="hintBtn">Hint</button>
                    <button class="btn btn-secondary" id="clearBtn">Clear</button>
                </div>
            </div>

            <div class="difficulty-buttons" id="difficultyButtons"></div>

            <div class="number-pad" id="numberPad"></div>
        </div>

        <div class="board-wrapper">
            <div class="game-board" id="gameBoard"></div>
            <div class="stats">
                <div class="difficulty-display">
                    <span class="stat-label">Difficulty:</span>
                    <span class="stat-value medium" id="difficultyDisplay">Medium</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Time:</span>
                    <span class="stat-value" id="timer">00:00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Hints:</span>
                    <span class="stat-value" id="hintCount">3</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Win Modal -->
    <div class="modal" id="winModal">
        <div class="modal-content">
            <div class="modal-title">üéâ Puzzle Solved!</div>
            <div class="modal-text" id="winText">Great job! You completed the sudoku puzzle.</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" id="playAgainBtn">Play Again</button>
                <a href="../index.html" class="modal-btn modal-btn-secondary" style="text-decoration: none;">Back Home</a>
            </div>
        </div>
    </div>

    <script>
        const EMPTY = 0;
        let currentDifficulty = 'medium';
        let gameDifficulty = 'medium';
        let board = [];
        let initialBoard = [];
        let selectedCell = null;
        let hintsRemaining = 3;
        let startTime = null;
        let timerInterval = null;
        let gameOver = false;
        let hintCells = new Set(); // Track hint cell positions
        let quarters = {}; // Store quarter notes: "row,col,quarter" -> number
        let quarterMode = null; // Current quarter mode: null (full), 'ul', 'ur', 'lr', 'll'

        const difficultyConfig = {
            easy: { clues: 45, label: 'Easy' },
            medium: { clues: 36, label: 'Medium' },
            hard: { clues: 27, label: 'Hard' }
        };

        // Initialize game
        function init() {
            createNumberPad();
            startNewGame();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Navbar info button
            document.getElementById('infoBtn').addEventListener('click', () => {
                document.getElementById('infoModal').classList.add('active');
            });
            document.getElementById('closeInfoBtn').addEventListener('click', () => {
                document.getElementById('infoModal').classList.remove('active');
            });
            document.getElementById('infoModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('infoModal')) {
                    document.getElementById('infoModal').classList.remove('active');
                }
            });

            document.getElementById('newGameBtn').addEventListener('click', startNewGame);

            // Difficulty dropdown
            document.getElementById('difficultyBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = document.getElementById('difficultyDropdown');
                dropdown.classList.toggle('show');
            });

            document.querySelectorAll('.difficulty-dropdown-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentDifficulty = e.target.dataset.difficulty;
                    updateNewGameButtonColor();
                    updateDifficultyDisplay();
                    document.getElementById('difficultyDropdown').classList.remove('show');
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                document.getElementById('difficultyDropdown').classList.remove('show');
            });

            document.getElementById('hintBtn').addEventListener('click', giveHint);
            document.getElementById('clearBtn').addEventListener('click', clearSelected);
            document.getElementById('playAgainBtn').addEventListener('click', startNewGame);

            document.querySelectorAll('.number-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (selectedCell !== null && !e.target.classList.contains('quarters-toggle')) {
                        const num = parseInt(e.target.textContent);
                        if (!isNaN(num)) {
                            setNumber(selectedCell, num);
                        }
                    }
                });
            });

            // Keyboard input for numbers 1-9 and backspace/delete
            document.addEventListener('keydown', (e) => {
                if (selectedCell !== null && !gameOver) {
                    const num = parseInt(e.key);
                    if (num >= 1 && num <= 9) {
                        e.preventDefault();
                        setNumber(selectedCell, num);
                    } else if (e.key === 'Backspace' || e.key === 'Delete') {
                        e.preventDefault();
                        // If in quarter mode, delete the quarter note
                        if (quarterMode !== null) {
                            delete quarters[`${selectedCell.row},${selectedCell.col},${quarterMode}`];
                            const row = selectedCell.row;
                            const col = selectedCell.col;
                            renderBoard();
                            selectedCell = null; // Clear so selectCell won't toggle unselect
                            const cellEl = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                            selectCell(row, col, cellEl);
                        } else {
                            setNumber(selectedCell, EMPTY);
                        }
                    }
                }
            });
        }

        function createNumberPad() {
            const pad = document.getElementById('numberPad');
            pad.innerHTML = '';
            for (let i = 1; i <= 9; i++) {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = i;
                pad.appendChild(btn);
            }
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'number-btn';
            deleteBtn.textContent = '‚å´';
            deleteBtn.addEventListener('click', () => {
                if (selectedCell !== null) {
                    setNumber(selectedCell, EMPTY);
                }
            });
            pad.appendChild(deleteBtn);

            // Add quarters toggle button
            const quartersBtn = document.createElement('button');
            quartersBtn.className = 'number-btn quarters-toggle';
            quartersBtn.textContent = '‚äû';
            quartersBtn.title = 'Toggle quarters/candidates mode';
            quartersBtn.addEventListener('click', () => {
                if (quarterMode === null) {
                    quarterMode = 'ul';
                } else if (quarterMode === 'ul') {
                    quarterMode = 'ur';
                } else if (quarterMode === 'ur') {
                    quarterMode = 'lr';
                } else if (quarterMode === 'lr') {
                    quarterMode = 'll';
                } else {
                    quarterMode = null;
                }
                // Update quarter indicator on the selected cell
                if (selectedCell !== null) {
                    const cellEl = document.querySelector(`[data-row="${selectedCell.row}"][data-col="${selectedCell.col}"]`);
                    if (cellEl) {
                        // Remove active class from all quarters
                        cellEl.querySelectorAll('.quarter.active').forEach(q => q.classList.remove('active'));
                        // Add/remove quarters-mode class based on quarterMode
                        if (quarterMode !== null) {
                            cellEl.classList.add('quarters-mode');
                            const quartersDiv = cellEl.querySelector('.quarters');
                            if (quartersDiv) {
                                const activeQuarter = quartersDiv.querySelector(`.quarter-${quarterMode}`);
                                if (activeQuarter) {
                                    activeQuarter.classList.add('active');
                                }
                            }
                        } else {
                            cellEl.classList.remove('quarters-mode');
                        }
                    }
                }
            });
            pad.appendChild(quartersBtn);
        }


        function startNewGame() {
            gameOver = false;
            hintsRemaining = 3;
            selectedCell = null;
            hintCells = new Set();
            quarters = {};
            quarterMode = null;
            gameDifficulty = currentDifficulty;
            document.getElementById('hintCount').textContent = '3';
            document.getElementById('winModal').classList.remove('active');

            if (timerInterval) clearInterval(timerInterval);
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            board = generateSudoku(difficultyConfig[currentDifficulty].clues);
            initialBoard = board.map(row => [...row]);
            renderBoard();
            updateNewGameButtonColor();
            updateDifficultyDisplay();
        }

        function updateNewGameButtonColor() {
            const newGameBtn = document.getElementById('newGameBtn');
            newGameBtn.classList.remove('easy', 'medium', 'hard');
            newGameBtn.classList.add(currentDifficulty);
        }

        function updateDifficultyDisplay() {
            const difficultyDisplay = document.getElementById('difficultyDisplay');
            const label = difficultyConfig[gameDifficulty].label;
            difficultyDisplay.textContent = label;
            difficultyDisplay.classList.remove('easy', 'medium', 'hard');
            difficultyDisplay.classList.add(gameDifficulty);
        }

        function generateSudoku(clues) {
            // Generate a solved board first
            const solved = Array(9).fill().map(() => Array(9).fill(0));
            fillBoard(solved);

            // Create puzzle by removing numbers with uniqueness check
            const puzzle = solved.map(row => [...row]);
            let cellsToRemove = 81 - clues;
            let attempts = 0;
            const maxAttempts = 5; // Limit attempts to avoid infinite loops

            while (cellsToRemove > 0 && attempts < maxAttempts) {
                const row = Math.floor(Math.random() * 9);
                const col = Math.floor(Math.random() * 9);

                if (puzzle[row][col] !== 0) {
                    const backup = puzzle[row][col];
                    puzzle[row][col] = 0;

                    // Check if puzzle still has exactly one solution
                    const solutionCount = countSolutions(puzzle, 2); // Stop after finding 2 solutions
                    if (solutionCount === 1) {
                        cellsToRemove--;
                        attempts = 0; // Reset attempts on success
                    } else {
                        // Restore the cell if it creates multiple solutions
                        puzzle[row][col] = backup;
                        attempts++;
                    }
                }
            }

            return puzzle;
        }

        function countSolutions(board, maxCount = 2) {
            // Count the number of solutions, stopping at maxCount for efficiency
            let count = [0]; // Use array to allow modification in nested function
            const boardCopy = board.map(row => [...row]);
            countSolutionsRecursive(boardCopy, count, maxCount);
            return count[0];
        }

        function countSolutionsRecursive(board, count, maxCount) {
            // Stop if we've found enough solutions
            if (count[0] >= maxCount) return;

            // Find next empty cell
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (board[row][col] === 0) {
                        // Try each number
                        for (let num = 1; num <= 9; num++) {
                            if (isValid(board, row, col, num)) {
                                board[row][col] = num;
                                countSolutionsRecursive(board, count, maxCount);
                                board[row][col] = 0;
                            }
                        }
                        return; // Backtrack
                    }
                }
            }

            // No empty cells found - we have a solution
            count[0]++;
        }

        function fillBoard(board) {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (board[row][col] === 0) {
                        const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9].sort(() => Math.random() - 0.5);
                        for (const num of nums) {
                            if (isValid(board, row, col, num)) {
                                board[row][col] = num;
                                if (fillBoard(board)) return true;
                                board[row][col] = 0;
                            }
                        }
                        return false;
                    }
                }
            }
            return true;
        }

        function isValid(board, row, col, num) {
            // Check row
            for (let x = 0; x < 9; x++) {
                if (board[row][x] === num) return false;
            }

            // Check column
            for (let x = 0; x < 9; x++) {
                if (board[x][col] === num) return false;
            }

            // Check 3x3 box
            const startRow = row - (row % 3);
            const startCol = col - (col % 3);
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (board[i + startRow][j + startCol] === num) return false;
                }
            }

            return true;
        }

        function renderBoard() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';

            // Create 9 box containers (3x3 grid of 3x3 boxes)
            for (let boxRow = 0; boxRow < 3; boxRow++) {
                for (let boxCol = 0; boxCol < 3; boxCol++) {
                    const box = document.createElement('div');
                    box.className = 'box';

                    // Create 9 cells within each box
                    for (let row = 0; row < 3; row++) {
                        for (let col = 0; col < 3; col++) {
                            const actualRow = boxRow * 3 + row;
                            const actualCol = boxCol * 3 + col;

                            const cell = document.createElement('div');
                            cell.className = 'cell';
                            const value = board[actualRow][actualCol];

                            if (initialBoard[actualRow][actualCol] !== 0) {
                                cell.classList.add('fixed');
                            }

                            // Check if this cell is a hint
                            if (hintCells.has(`${actualRow},${actualCol}`)) {
                                cell.classList.add('hint');
                            }

                            if (value !== 0) {
                                cell.textContent = value;
                            } else {
                                // Add quarters container for empty cells
                                const quartersDiv = document.createElement('div');
                                quartersDiv.className = 'quarters';
                                const quarterNames = ['ul', 'ur', 'll', 'lr'];
                                quarterNames.forEach(qname => {
                                    const quarter = document.createElement('div');
                                    quarter.className = `quarter quarter-${qname}`;
                                    const qNum = quarters[`${actualRow},${actualCol},${qname}`];
                                    if (qNum) {
                                        quarter.textContent = qNum;
                                    }
                                    quartersDiv.appendChild(quarter);
                                });
                                cell.appendChild(quartersDiv);
                            }

                            cell.addEventListener('click', () => selectCell(actualRow, actualCol, cell));
                            cell.dataset.row = actualRow;
                            cell.dataset.col = actualCol;

                            box.appendChild(cell);
                        }
                    }

                    gameBoard.appendChild(box);
                }
            }
        }

        function selectCell(row, col, element) {
            if (initialBoard[row][col] !== 0) return;

            // Check if clicking the already selected cell - toggle unselect
            if (selectedCell && selectedCell.row === row && selectedCell.col === col) {
                document.querySelectorAll('.cell.selected, .cell.related, .cell.same-block').forEach(c => {
                    c.classList.remove('selected', 'related', 'same-block', 'quarters-mode');
                    c.querySelectorAll('.quarter.active').forEach(q => q.classList.remove('active'));
                });
                selectedCell = null;
                return;
            }

            // Exit quarter mode when selecting a different cell
            quarterMode = null;

            // Remove previous selection
            document.querySelectorAll('.cell.selected, .cell.related, .cell.same-block').forEach(c => {
                c.classList.remove('selected', 'related', 'same-block', 'quarters-mode');
                c.querySelectorAll('.quarter.active').forEach(q => q.classList.remove('active'));
            });

            selectedCell = { row, col };
            element.classList.add('selected');

            // Highlight active quarter if in quarter mode
            if (quarterMode !== null) {
                element.classList.add('quarters-mode');
                const quartersDiv = element.querySelector('.quarters');
                if (quartersDiv) {
                    const activeQuarter = quartersDiv.querySelector(`.quarter-${quarterMode}`);
                    if (activeQuarter) {
                        activeQuarter.classList.add('active');
                    }
                }
            }

            // Highlight related cells (same row/column)
            for (let i = 0; i < 9; i++) {
                if (i !== col) {
                    document.querySelector(`[data-row="${row}"][data-col="${i}"]`)?.classList.add('related');
                }
                if (i !== row) {
                    document.querySelector(`[data-row="${i}"][data-col="${col}"]`)?.classList.add('related');
                }
            }

            // Highlight cells in same 3x3 block (but not same row/column)
            const startRow = row - (row % 3);
            const startCol = col - (col % 3);
            for (let i = startRow; i < startRow + 3; i++) {
                for (let j = startCol; j < startCol + 3; j++) {
                    if (i !== row && j !== col) {
                        document.querySelector(`[data-row="${i}"][data-col="${j}"]`)?.classList.add('same-block');
                    }
                }
            }

            // Enable/disable quarters button based on whether cell is empty
            const quartersBtn = document.querySelector('.quarters-toggle');
            if (quartersBtn) {
                if (board[row][col] === EMPTY) {
                    quartersBtn.disabled = false;
                } else {
                    quartersBtn.disabled = true;
                }
            }
        }

        function setNumber(cell, num) {
            if (initialBoard[cell.row][cell.col] !== 0) return;

            // Handle quarter mode
            if (quarterMode !== null && num !== EMPTY) {
                quarters[`${cell.row},${cell.col},${quarterMode}`] = num;
                renderBoard();
                selectedCell = null; // Clear so selectCell won't toggle unselect
                const cellEl = document.querySelector(`[data-row="${cell.row}"][data-col="${cell.col}"]`);
                selectCell(cell.row, cell.col, cellEl);
                return;
            }

            // Set main number
            board[cell.row][cell.col] = num;

            // Clear all quarters for this cell when setting a number or clearing the cell
            const quarterNames = ['ul', 'ur', 'll', 'lr'];
            quarterNames.forEach(qname => {
                delete quarters[`${cell.row},${cell.col},${qname}`];
            });

            renderBoard();
            updateErrorHighlighting();
            checkWin();

            // Restore selection
            selectedCell = null; // Clear so selectCell won't toggle unselect
            const cellEl = document.querySelector(`[data-row="${cell.row}"][data-col="${cell.col}"]`);
            selectCell(cell.row, cell.col, cellEl);
        }

        function updateErrorHighlighting() {
            // Clear all error classes
            document.querySelectorAll('.cell.error').forEach(cell => {
                cell.classList.remove('error');
            });

            // Find all cells with conflicts
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (board[row][col] !== EMPTY && !isValidPlacement(row, col, board[row][col])) {
                        document.querySelector(`[data-row="${row}"][data-col="${col}"]`)?.classList.add('error');
                    }
                }
            }
        }

        function isValidPlacement(row, col, num) {
            // Check row
            for (let x = 0; x < 9; x++) {
                if (x !== col && board[row][x] === num) return false;
            }

            // Check column
            for (let x = 0; x < 9; x++) {
                if (x !== row && board[x][col] === num) return false;
            }

            // Check 3x3 box
            const startRow = row - (row % 3);
            const startCol = col - (col % 3);
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const r = i + startRow;
                    const c = j + startCol;
                    if ((r !== row || c !== col) && board[r][c] === num) return false;
                }
            }

            return true;
        }

        function giveHint() {
            if (hintsRemaining === 0 || gameOver) return;

            let emptyFound = false;
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (board[row][col] === 0 && initialBoard[row][col] === 0) {
                        board[row][col] = findSolution(row, col);
                        hintCells.add(`${row},${col}`);
                        renderBoard();
                        emptyFound = true;
                        hintsRemaining--;
                        document.getElementById('hintCount').textContent = hintsRemaining;
                        return;
                    }
                }
            }
        }

        function findSolution(row, col) {
            for (let num = 1; num <= 9; num++) {
                if (isValid(board, row, col, num)) {
                    return num;
                }
            }
            return 0;
        }

        function clearSelected() {
            if (!selectedCell || initialBoard[selectedCell.row][selectedCell.col] !== 0) {
                return;
            }

            const row = selectedCell.row;
            const col = selectedCell.col;
            board[row][col] = EMPTY;

            // Clear all quarters for this cell
            const quarterNames = ['ul', 'ur', 'll', 'lr'];
            quarterNames.forEach(qname => {
                delete quarters[`${row},${col},${qname}`];
            });

            renderBoard();
            selectedCell = null; // Clear so selectCell won't toggle unselect

            const cellEl = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            if (cellEl) {
                selectCell(row, col, cellEl);
            }
        }

        function checkWin() {
            let isFilled = true;
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (board[row][col] === 0) {
                        isFilled = false;
                        break;
                    }
                    if (!isValidPlacement(row, col, board[row][col])) {
                        return;
                    }
                }
            }

            if (isFilled) {
                gameOver = true;
                if (timerInterval) clearInterval(timerInterval);
                const time = document.getElementById('timer').textContent;
                document.getElementById('winText').textContent = `Great job! You completed the sudoku in ${time}.`;
                document.getElementById('winModal').classList.add('active');
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('timer').textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Start the game
        window.addEventListener('load', init);
    </script>
</body>
</html>
